version: '3.7'

services:
  ssh:
    hostname: kitt
    image: registry.defn.sh/defn/home
    restart: always
    entrypoint: [ "/etc/kitt-init" ]
    user: root
    extra_hosts:
      - host.docker.internal:172.18.0.1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./etc/ssh:/etc/ssh:ro
      - ./etc/kitt-init:/etc/kitt-init:ro
      - ${HOME}/work:/app/src/work
      - ${HOME}/.password-store:/app/src/.password-store
      - home:/home
  cloudflared:
    image: letfn/cloudflared
    restart: always
    volumes:
      - ${HOME}/.cloudflared:/etc/cloudflared
    environment:
      - TUNNEL_URL=ssh://ssh:2222
      - TUNNEL_HOSTNAME
    links:
      - ssh

networks:
  default:
    external:
      name: kitt

volumes:
  home:
