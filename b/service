#!/usr/bin/env bash

function main {
  case "$1" in

  cloudflared)
    shift
    cd

    origin=localhost
    if grep sshd /etc/hosts; then
      origin=sshd
    fi
    export TUNNEL_URL=ssh://${origin}:2222 TUNNEL_HOSTNAME="${1}" TUNNEL_ORIGIN_CERT="/efs/cloudflare/cert-${1}.pem"

    while true; do
      cloudflared tunnel --no-autoupdate
      sleep 10
    done
    ;;

  sshd)
    shift

    env | grep ^AWS_ | sort | sudo tee /etc/aws.env > /dev/null

    if [[ -f /data/home-secret/trusted-user-ca-keys.pem ]]; then
      install -o root -g root -m 0400 /data/home-secret/trusted-user-ca-keys.pem /etc/ssh/trusted-user-ca-keys.pem
    fi

    exec /tini -- /usr/sbin/sshd -D -o UseDNS=no -o UsePAM=yes -o PasswordAuthentication=no -o Port=2222 -e
    ;;

  esac
}

main "$@"
