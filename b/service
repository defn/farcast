#!/usr/bin/env bash

function main {
  if [[ -w /data ]]; then
    if ! test -f /data/.hello; then
      echo "$(date) $(uname -a)" > /data/.hello
    fi
  fi

  env | grep ^AWS_ | sort | sudo tee /etc/aws.env > /dev/null

  if [[ -f /data/home-secret/trusted-user-ca-keys.pem ]]; then
    cp /data/home-secret/trusted-user-ca-keys.pem /etc/ssh/trusted-user-ca-keys.pem
  elif [[ -n "${HOME_TRUSTED_USER_CA_KEYS:-}" ]]; then
    echo "${HOME_TRUSTED_USER_CA_KEYS}" | base64 -d > /etc/ssh/trusted-user-ca-keys.pem
  fi

  echo TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem | sudo tee -a /etc/ssh/sshd_config

  if [[ -n "${GITHUB_USER:-}" ]]; then
    sudo -u app mkdir /home/app/.ssh
    sudo -u app chmod 700 /home/app/.ssh
    curl -s "https://api.github.com/users/${GITHUB_USER}/keys" | jq -r '.[].key' | sudo -u app tee -a /home/app/.ssh/authorized_keys
    sudo -u app chmod 600 /home/app/.ssh/authorized_keys
  fi

  if [[ "$$" == 1 ]]; then
    exec /tini -- /usr/sbin/sshd -D -o UseDNS=no -o UsePAM=yes -o PasswordAuthentication=no -o Port=2222 -e
  else
    exec /usr/sbin/sshd -D -o UseDNS=no -o UsePAM=yes -o PasswordAuthentication=no -o Port=2222 -e
  fi
}

main "$@"
